<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>The Roped Team - Mountain Habit Tracker</title>
    <meta name="description"
        content="A collaborative habit tracking app where 8 climbers work together to reach the summit. One team, one goal, 90 days to the top.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="first-anchor-styles.css">
    <link rel="stylesheet" href="time-patterns-styles.css">
    <link rel="stylesheet" href="mountain-trail.css">
</head>

<body>
    <!-- Background Mountain Scene -->
    <div class="mountain-backdrop"></div>
    <div class="stars"></div>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">ğŸ”ï¸</div>
                    <div class="logo-text">
                        <h1>The Roped Team</h1>
                        <p class="tagline">Together to the Summit</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="summit-prize">
                        <span class="prize-label">Summit Prize</span>
                        <span class="prize-value" id="summitPrize">Team Celebration Dinner</span>
                    </div>
                </div>
            </div>
            <!-- User Info - Below Summit Prize -->
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-name" id="userName">Loading...</span>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </header>

        <!-- First Anchor Badge -->
        <section class="first-anchor-badge" id="firstAnchorBadge" style="display: none;">
            <!-- Content will be dynamically generated -->
        </section>

        <!-- Main Dashboard -->
        <main class="dashboard">
            <!-- Mountain Trail Progress (HERO ELEMENT) -->
            <section class="mountain-trail-section" id="mountainTrailSection">
                <!-- Screen reader announcement -->
                <div class="sr-only" role="status" aria-live="polite" id="trailAnnouncement">
                    Progress: <span id="srProgress">0</span>%.
                    You are at day <span id="srDay">1</span> of <span id="srTotal">90</span>.
                </div>

                <!-- SVG Trail Container -->
                <div class="mountain-trail-container" id="mountainTrailContainer">
                    <!-- Summit glow effect -->
                    <div class="summit-glow"></div>
                    <!-- Fog overlay at base -->
                    <div class="trail-fog-overlay"></div>
                    <!-- Dynamically generated SVG will be inserted here -->
                </div>

                <!-- Progress Narrative -->
                <div class="progress-narrative" id="progressNarrative">
                    ğŸ¥¾ Your expedition begins! Take your first step today.
                </div>

                <!-- Trail Stats -->
                <div class="trail-stats">
                    <div class="trail-stat">
                        <span class="trail-stat-value" id="trailDay">1</span>
                        <span class="trail-stat-label">/ <span id="trailTotal">90</span> Days</span>
                    </div>
                    <div class="trail-stat">
                        <span class="trail-stat-value" id="trailAltitude">0%</span>
                        <span class="trail-stat-label">Altitude</span>
                    </div>
                </div>

                <!-- Team Toggle -->
                <div class="team-toggle" id="teamToggle" role="button" tabindex="0" aria-pressed="false">
                    <span class="team-toggle-text">
                        <span id="teammateCount">0</span> teammates climbing with you
                    </span>
                    <span class="team-toggle-icon" id="teamToggleIcon">ğŸ‘¥</span>
                </div>

                <!-- Team Legend (Hidden by default) -->
                <div class="team-legend" id="teamLegend" aria-hidden="true">
                    <!-- Dynamically populated -->
                </div>

                <!-- Expand Button -->
                <button class="expand-button" id="expandTrailBtn" aria-expanded="false">
                    Explore Full Journey
                </button>
            </section>

            <!-- Stats Grid (Below Trail) -->
            <section class="progress-overview" id="progressStats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">â›º</div>
                        <div class="stat-content">
                            <div class="stat-value" id="baseCampsCount">0</div>
                            <div class="stat-label">Camps</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ”¥</div>
                        <div class="stat-content">
                            <div class="stat-value" id="teamStreak">0</div>
                            <div class="stat-label">Team Streak</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-content">
                            <div class="stat-value" id="todayCheckins">0/8</div>
                            <div class="stat-label">Today's Anchors</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- User Check-in Panel (Prominently placed at top) -->
            <section class="checkin-panel">
                <div class="checkin-card">
                    <!-- Personalized Check-in (for regular members) -->
                    <div id="personalizedCheckin" class="personalized-checkin" style="display: none;">
                        <h3 id="memberGreeting">Good day, Climber!</h3>
                        <p class="habit-question">Have you completed <strong id="memberHabit">your habit</strong> today?
                        </p>
                        <button id="quickCheckinBtn" class="quick-checkin-btn">
                            <span class="btn-icon">âœ…</span>
                            <span class="btn-text">Yes, I did it!</span>
                        </button>
                        <p class="checkin-status" id="quickCheckinStatus"></p>
                    </div>

                    <!-- Admin Dropdown (only for admin) -->
                    <div id="adminCheckin" class="admin-checkin" style="display: none;">
                        <h3>Admin Check-in</h3>
                        <div class="user-selector">
                            <label for="userSelect">Select Climber:</label>
                            <select id="userSelect" class="user-select">
                                <option value="">Choose climber...</option>
                            </select>
                        </div>
                        <button id="checkinBtn" class="checkin-btn" disabled>
                            <span class="btn-icon">âš“</span>
                            <span class="btn-text">Anchor Secured</span>
                        </button>
                        <p class="checkin-status" id="checkinStatus"></p>
                    </div>
                </div>
            </section>

            <!-- Team Progress Overview - All Members 30-Day History -->
            <section class="team-progress-overview">
                <h2 class="section-title">Team Progress Overview - Last 30 Days</h2>
                <p class="section-subtitle">Track everyone's journey at a glance</p>

                <div class="team-progress-grid" id="teamProgressGrid">
                    <!-- Team member progress cards will be dynamically inserted here -->
                </div>
            </section>

            <!-- First Anchors History - Last 30 Days -->
            <section class="first-anchors-history-section">
                <h2 class="section-title">âš“ First Anchors - Last 30 Days</h2>
                <p class="section-subtitle">Who's been the most dedicated early riser?</p>
                <div class="first-anchors-list" id="firstAnchorsList">
                    <!-- History will be dynamically generated -->
                </div>
            </section>

            <!-- The Roped Team Visualization -->
            <section class="roped-team-section">
                <h2 class="section-title">The Roped Team</h2>
                <div class="rope-container" id="ropeContainer">
                    <!-- Climbers will be dynamically inserted here -->
                </div>
            </section>

            <!-- Individual Member Progress (Shows when user is selected) - MOVED BEFORE CAMPS -->
            <section class="personal-progress-section hidden" id="personalProgressSection">
                <h2 class="section-title">
                    <span id="personalProgressName">Your</span> Personal Journey
                </h2>

                <div class="personal-stats-grid">
                    <div class="personal-stat-card">
                        <div class="personal-stat-icon">ğŸ“Š</div>
                        <div class="personal-stat-content">
                            <div class="personal-stat-value" id="personalTotalCheckins">0</div>
                            <div class="personal-stat-label">Total Check-ins</div>
                        </div>
                    </div>
                    <div class="personal-stat-card">
                        <div class="personal-stat-icon">ğŸ”¥</div>
                        <div class="personal-stat-content">
                            <div class="personal-stat-value" id="personalCurrentStreak">0</div>
                            <div class="personal-stat-label">Current Streak</div>
                        </div>
                    </div>
                    <div class="personal-stat-card">
                        <div class="personal-stat-icon">ğŸ†</div>
                        <div class="personal-stat-content">
                            <div class="personal-stat-value" id="personalBestStreak">0</div>
                            <div class="personal-stat-label">Best Streak</div>
                        </div>
                    </div>
                    <div class="personal-stat-card">
                        <div class="personal-stat-icon">ğŸ“ˆ</div>
                        <div class="personal-stat-content">
                            <div class="personal-stat-value" id="personalCompletionRate">0%</div>
                            <div class="personal-stat-label">Completion Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Time Patterns Section -->
                <div class="personal-time-patterns" id="personalTimePatterns">
                    <!-- Time patterns will be dynamically generated -->
                </div>

                <div class="personal-calendar">
                    <h3>Your Check-in History (Last 30 Days)</h3>
                    <div class="calendar-grid" id="personalCalendar">
                        <!-- Calendar will be dynamically generated -->
                    </div>
                    <div class="calendar-legend">
                        <span class="legend-item"><span class="legend-box checked"></span> Checked In</span>
                        <span class="legend-item"><span class="legend-box missed"></span> Missed</span>
                        <span class="legend-item"><span class="legend-box future"></span> Future</span>
                    </div>
                </div>
            </section>

            <!-- Weekly Milestones - NOW COLLAPSIBLE AND BELOW PERSONAL JOURNEY -->
            <section class="milestones-section">
                <div class="section-header-with-toggle">
                    <h2 class="section-title">Camps Established</h2>
                    <button class="collapse-toggle" id="campsToggle" aria-expanded="false">
                        <span class="toggle-icon">â–¼</span>
                        <span class="toggle-text">Expand</span>
                    </button>
                </div>
                <div class="milestones-grid collapsed" id="milestonesGrid">
                    <!-- Milestone markers will be dynamically inserted -->
                </div>
            </section>

        </main>

        <!-- Admin Panel (At bottom of page) -->
        <aside class="admin-panel" id="adminPanel">
            <button class="admin-toggle" id="adminToggle">âš™ï¸ Admin</button>
            <div class="admin-content" id="adminContent">
                <h3>Admin Settings</h3>

                <div class="admin-section">
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" placeholder="K2 Conquerors" value="K2 Conquerors">
                </div>

                <div class="admin-section">
                    <label for="prizeName">Summit Prize:</label>
                    <input type="text" id="prizeName" placeholder="Team Celebration Dinner"
                        value="Team Celebration Dinner">
                </div>

                <div class="admin-section">
                    <label for="goalWeeks">Challenge Duration (weeks):</label>
                    <input type="number" id="goalWeeks" min="4" max="52" value="13" placeholder="13">
                    <small style="display: block; color: #B8E6F5; margin-top: 0.25rem;">Between 4-52 weeks (default: 13
                        weeks = 91 days)</small>
                </div>

                <div class="admin-section">
                    <label>Major Milestone Rewards:</label>
                    <small style="display: block; color: #B8E6F5; margin-bottom: 0.75rem;">Rewards at 25%, 50%, 75%, and
                        100% completion</small>

                    <div style="display: grid; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="min-width: 80px; font-size: 1.2em;">ğŸ”ï¸ 25%:</span>
                            <input type="text" id="reward25" placeholder="Team Lunch" style="flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="min-width: 80px; font-size: 1.2em;">â›°ï¸ 50%:</span>
                            <input type="text" id="reward50" placeholder="Movie Night" style="flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="min-width: 80px; font-size: 1.2em;">ğŸ¯ 75%:</span>
                            <input type="text" id="reward75" placeholder="Adventure Day" style="flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="min-width: 80px; font-size: 1.2em;">ğŸ† 100%:</span>
                            <input type="text" id="reward100" placeholder="Grand Celebration" style="flex: 1;">
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <label for="teamSize">Team Size:</label>
                    <input type="number" id="teamSize" min="1" max="30" value="8" placeholder="8">
                    <button id="updateTeamSizeBtn" class="admin-save-btn"
                        style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem;">
                        Update Team Size
                    </button>
                    <small style="display: block; color: #B8E6F5; margin-top: 0.25rem;">Between 1-30 members (default:
                        8)</small>
                </div>

                <div class="admin-section">
                    <label>Team Members (<span id="currentTeamSize">8</span>):</label>
                    <div
                        style="background: rgba(74, 144, 226, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.875rem;">
                        <strong>ğŸ’¡ Member Linking Guide:</strong><br>
                        âœ… <strong>Linked</strong> - User account connected and ready<br>
                        â³ <strong>Pending</strong> - Email added, waiting for user registration<br>
                        â• <strong>Need Email</strong> - Add email to enable automatic linking
                    </div>
                    <div class="members-list" id="membersList">
                        <!-- Member inputs will be here -->
                    </div>
                </div>

                <div class="admin-section"
                    style="border-top: 2px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: 1rem;">
                    <label>ğŸ”— Link Member to Team:</label>
                    <p style="font-size: 0.875rem; color: #B8E6F5; margin-bottom: 0.5rem;">
                        If a member created their own team by mistake, enter their email here to move them to this team.
                    </p>
                    <input type="email" id="linkMemberEmail" placeholder="member@email.com"
                        style="margin-bottom: 0.5rem;">
                    <button id="linkMemberBtn" class="admin-save-btn"
                        style="background: linear-gradient(135deg, #4A90E2, #357ABD);">
                        Link Member
                    </button>
                    <div id="linkStatus" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                </div>

                <div class="admin-section"
                    style="border-top: 2px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 1rem;">
                    <label>ğŸ—“ï¸ Reset Expedition Start Date:</label>
                    <p style="font-size: 0.875rem; color: #FCA5A5; margin-bottom: 0.5rem;">
                        âš ï¸ <strong>Warning:</strong> This will change the start date and delete ALL check-ins before the
                        new
                        date. Use this only if some members couldn't join on the original start date.
                    </p>
                    <input type="date" id="newStartDate" value="2026-01-01" style="margin-bottom: 0.5rem;">
                    <button id="resetStartDateBtn" class="admin-save-btn"
                        style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                        Reset Start Date
                    </button>
                    <div id="resetStartStatus" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                </div>

                <button id="saveSettings" class="admin-save-btn">Save Settings</button>
                <button id="resetProgress" class="admin-reset-btn">Reset Progress</button>
            </div>
        </aside>
    </div>

    <!-- Celebration Modal -->
    <div class="modal" id="celebrationModal">
        <div class="modal-content celebration-content">
            <div class="celebration-animation">ğŸ‰</div>
            <h2 id="celebrationTitle">Base Camp Established!</h2>
            <p id="celebrationMessage">The team completed a perfect week!</p>
            <button class="modal-close-btn" id="closeCelebration">Continue Climbing</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Firebase Integration -->
    <script src="firebase-integration.js"></script>

    <!-- Original App -->
    <script src="app.js"></script>
</body>

</html>